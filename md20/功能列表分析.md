# 系统功能列表分析

## 项目概述
这是一个完整的店内管理系统，包含财务管理、资产管理、材料管理、饮品管理、检查管理等多个模块。系统采用原生 PHP 开发，MVC 架构，支持中越双语。

---

## 一、核心功能模块

### 1. 用户认证与权限管理 (AuthController)

**功能：**
- ✅ 用户登录/登出
- ✅ 基于角色的访问控制（RBAC）
- ✅ 四种角色：
  - **Owner（老板）**：全权限、查看所有统计、删除/作废记录
  - **Manager（店长）**：录入、查看、审批
  - **Accountant（财务）**：录入、审核、导出
  - **Staff（员工）**：只能新增记录，不能删除，只能看自己提交的
- ✅ Session 管理
- ✅ 密码加密存储（password_hash）

**实现位置：**
- `app/core/Auth.php` - 认证核心类
- `app/controllers/AuthController.php` - 登录控制器
- `app/models/User.php` - 用户模型

---

### 2. 交易管理 (TransactionController)

**功能：**
- ✅ **创建交易** (`create`)
  - 支持收入/支出两种类型
  - 选择分类、支付方式、供应商
  - 设置金额、货币、发生时间、备注
  - 上传凭证图片（附件）
  - CSRF 防护
  
- ✅ **交易列表** (`list`)
  - 支持多条件筛选：
    - 类型（收入/支出）
    - 日期范围（从/到）
    - 分类
    - 支付方式
    - 创建人
    - 关键词搜索（备注、供应商）
  - 分页显示（默认200条）
  - 按发生时间倒序排列

- ✅ **交易详情** (`view`)
  - 查看单笔交易的完整信息
  - 显示关联的分类、支付方式、供应商、创建人
  - 查看附件
  - 查看作废请求记录

- ✅ **交易作废** (`void`)
  - 仅限老板和财务角色操作
  - 将交易状态改为 'void'
  - 作废的交易不会出现在统计中

- ✅ **申请作废** (`requestVoid`)
  - 员工可以申请作废交易
  - 需要填写作废原因

**实现位置：**
- `app/controllers/TransactionController.php`
- `app/models/Transaction.php`
- `app/models/VoidRequest.php`
- `app/views/transactions/`

---

### 3. 报表统计 (ReportController)

**功能：**
- ✅ **Dashboard 仪表盘** (`dashboard`)
  - 今日统计：今日收入/支出总额
  - 本月统计：本月收入/支出总额
  - 7天趋势：最近7天的收入/支出趋势图
  - 最近10笔流水：最新交易记录

- ✅ **汇总统计** (`summary`) - API接口
  - 支持时间范围：今天、最近7天、本月
  - 返回 JSON 格式的收入/支出汇总

- ✅ **分类统计** (`byCategory`) - API接口
  - 按分类统计收入/支出
  - 支持按类型筛选
  - 支持时间范围筛选

**实现位置：**
- `app/controllers/ReportController.php`
- `app/models/Transaction.php` (统计方法)
- `app/views/reports/dashboard.php`

---

### 4. 设置管理 (SettingController)

**功能：**
- ✅ **分类管理** (`categories`)
  - 创建/编辑/删除分类
  - 支持收入/支出/两者三种类型
  - 支持二级分类（parent_id）
  - 中越双语名称
  - 激活/停用状态
  - 权限：老板、店长、财务

- ✅ **支付方式管理** (`paymentMethods`)
  - 创建/编辑/删除支付方式
  - 中越双语名称
  - 激活/停用状态
  - 默认包含：现金、POS机刷卡、VNPAY、ZaloPay、Momo
  - 权限：老板、店长、财务

- ✅ **供应商管理** (`vendors`)
  - 创建/编辑/删除供应商
  - 包含名称、电话、备注
  - 激活/停用状态
  - 权限：老板、店长、财务

- ✅ **用户管理** (`users`)
  - 创建/编辑用户
  - 设置用户名、密码、显示名称
  - 分配角色
  - 激活/停用用户
  - 权限：老板、店长、财务

**实现位置：**
- `app/controllers/SettingController.php`
- `app/models/Category.php`
- `app/models/PaymentMethod.php`
- `app/models/Vendor.php`
- `app/models/User.php`
- `app/views/settings/`

---

### 5. 资产管理 (AssetsController)

**功能：**
- ✅ **资产列表** (`list`)
  - 查看所有资产
  - 权限：老板、店长、财务

- ✅ **创建资产** (`create`)
  - 分类（coffee/office/whiskey）
  - 子分类
  - 名称
  - 楼层（floor）
  - 位置（location）
  - 价格
  - 数量
  - 获得日期
  - 备注
  - 上传资产图片（支持多图）

- ✅ **资产详情** (`view`)
  - 查看资产完整信息
  - 查看资产附件（图片）

- ✅ **资产作废** (`void`)
  - 将资产状态改为 'void'
  - 权限：老板、店长、财务

- ✅ **资产导出** (`export`)
  - 导出为 CSV 格式
  - 包含：分类、子分类、名称、楼层、位置、价格、获得日期、备注

- ✅ **资产导入** (`import`)
  - 从 CSV 文件批量导入资产
  - 支持 coffee/office/whiskey 三种店铺类型

**实现位置：**
- `app/controllers/AssetsController.php`
- `app/models/Asset.php`
- `app/models/AssetAttachment.php`
- `app/views/assets/`

---

### 6. 材料管理 (MaterialsController)

**功能：**
- ✅ **材料列表** (`list`)
  - 按名称分组显示材料
  - 显示库存数量、最小库存、单位等
  - 权限：老板、店长、财务

- ✅ **创建/入库材料** (`create`)
  - 材料名称
  - 分类
  - 店铺（coffee/office/whiskey）
  - 单位
  - 数量（入库数量）
  - 最小库存预警
  - 备注
  - 上传材料图片（支持多图）
  - 如果材料已存在，则增加库存；否则创建新材料

**实现位置：**
- `app/controllers/MaterialsController.php`
- `app/models/Material.php`
- `app/models/MaterialAttachment.php`
- `app/views/materials/`

---

### 7. 饮品管理 (DrinksController)

**功能：**
- ✅ **饮品配方管理** (`recipes`)
  - 创建饮品
  - 设置饮品配方（选择材料及用量）
  - 保存/更新配方
  - 权限：老板、店长、财务

- ✅ **饮品消耗** (`consume`)
  - 选择饮品
  - 输入消耗数量
  - 自动扣减对应材料的库存
  - 记录消耗日志
  - 设置发生日期和备注
  - 权限：老板、店长、财务

**实现位置：**
- `app/controllers/DrinksController.php`
- `app/models/Drink.php`
- `app/models/DrinkRecipe.php`
- `app/models/ConsumptionLog.php`
- `app/views/drinks/`

---

### 8. 检查管理 (InspectionsController)

**功能：**
- ✅ **检查列表** (`list`)
  - 按日期查看检查记录
  - 显示店铺、楼层、房间、状态等信息
  - 所有登录用户可查看

- ✅ **创建检查** (`create`)
  - 店铺（coffee/office/whiskey）
  - 楼层（1F/2F等）
  - 访问次数（visit_no）
  - 房间（room）
  - 状态（ok/problem等）
  - 检查日期（spot_date）
  - 备注
  - 上传检查照片（支持多图）
  - 所有登录用户可创建

- ✅ **检查详情** (`view`)
  - 查看检查完整信息
  - 查看检查照片

- ✅ **检查审核** (`review`)
  - 审核检查记录
  - 设置审核状态（confirmed等）
  - 添加审核备注
  - 权限：老板、店长、财务

**实现位置：**
- `app/controllers/InspectionsController.php`
- `app/models/Inspection.php`
- `app/models/InspectionPhoto.php`
- `app/views/inspections/`

---

## 二、API 接口模块

### 1. 交易 API (TransactionApiController)

**接口：**
- ✅ `GET /api.php?r=transaction/list` - 获取交易列表（支持筛选）
- ✅ `GET /api.php?r=transaction/view` - 获取交易详情
- ✅ `POST /api.php?r=transaction/create` - 创建交易（JSON）
- ✅ `POST /api.php?r=transaction/void` - 作废交易

**认证：**
- 使用 `ApiGuard` 进行认证
- 支持 Token 或 Session 认证

---

### 2. 检查 API (InspectionApiController)

**接口：**
- ✅ `GET /api.php?r=inspection/list` - 获取检查列表
- ✅ `GET /api.php?r=inspection/view` - 获取检查详情
- ✅ `POST /api.php?r=inspection/create` - 创建检查（支持图片上传）
- ✅ `POST /api.php?r=inspection/review` - 审核检查

**认证：**
- 使用 `ApiGuard` 进行认证

---

### 3. 认证 API (AuthApiController)

**接口：**
- ✅ 登录接口
- ✅ 获取当前用户信息

**实现位置：**
- `app/controllers/api/AuthApiController.php`
- `app/core/ApiGuard.php`

---

## 三、数据模型

### 核心数据表

1. **roles** - 角色表（4种角色）
2. **users** - 用户表
3. **categories** - 分类表（支持二级分类）
4. **payment_methods** - 支付方式表
5. **vendors** - 供应商表
6. **transactions** - 交易表（核心表）
7. **attachments** - 附件表（交易凭证）
8. **void_requests** - 作废请求表
9. **assets** - 资产表
10. **asset_attachments** - 资产附件表
11. **materials** - 材料表
12. **material_attachments** - 材料附件表
13. **drinks** - 饮品表
14. **drink_recipes** - 饮品配方表
15. **consumption_logs** - 消耗日志表
16. **inspections** - 检查表
17. **inspection_photos** - 检查照片表

---

## 四、技术特性

### 安全特性
- ✅ SQL 注入防护（PDO 预处理语句）
- ✅ XSS 防护（htmlspecialchars 转义）
- ✅ CSRF 防护（CSRF Token）
- ✅ 密码安全（password_hash）
- ✅ 权限控制（RBAC）

### 国际化支持
- ✅ 中越双语（ZH + VI）
- ✅ 通过 `?lang=zh` 或 `?lang=vi` 切换
- ✅ Session 保存语言选择
- ✅ 使用 `__('key')` 函数获取翻译

### 文件上传
- ✅ 支持图片上传（JPEG、PNG、GIF、WebP）
- ✅ 文件大小限制（10MB）
- ✅ MIME 类型验证
- ✅ 安全的文件命名
- ✅ 支持多文件上传

---

## 五、功能统计

### 已实现功能总数：**30+**

#### 按模块分类：
- **用户认证**：2 个功能
- **交易管理**：5 个功能
- **报表统计**：3 个功能
- **设置管理**：4 个功能
- **资产管理**：6 个功能
- **材料管理**：2 个功能
- **饮品管理**：2 个功能
- **检查管理**：4 个功能
- **API 接口**：8+ 个接口

---

## 六、权限矩阵

| 功能模块 | Owner | Manager | Accountant | Staff |
|---------|-------|---------|------------|-------|
| 登录/登出 | ✅ | ✅ | ✅ | ✅ |
| 创建交易 | ✅ | ✅ | ✅ | ✅ |
| 查看交易 | ✅ | ✅ | ✅ | ✅（仅自己） |
| 作废交易 | ✅ | ❌ | ✅ | ❌ |
| 申请作废 | ✅ | ✅ | ✅ | ✅ |
| 查看报表 | ✅ | ✅ | ✅ | ❌ |
| 分类管理 | ✅ | ✅ | ✅ | ❌ |
| 支付方式管理 | ✅ | ✅ | ✅ | ❌ |
| 供应商管理 | ✅ | ✅ | ✅ | ❌ |
| 用户管理 | ✅ | ✅ | ✅ | ❌ |
| 资产管理 | ✅ | ✅ | ✅ | ❌ |
| 材料管理 | ✅ | ✅ | ✅ | ❌ |
| 饮品管理 | ✅ | ✅ | ✅ | ❌ |
| 创建检查 | ✅ | ✅ | ✅ | ✅ |
| 审核检查 | ✅ | ✅ | ✅ | ❌ |

---

## 七、路由列表

### Web 路由（通过 `?r=controller/action`）

- `auth/login` - 登录
- `auth/logout` - 登出
- `reports/dashboard` - 仪表盘（默认首页）
- `transactions/list` - 交易列表
- `transactions/create` - 创建交易
- `transactions/view` - 交易详情
- `transactions/void` - 作废交易
- `transactions/requestVoid` - 申请作废
- `settings/categories` - 分类管理
- `settings/paymentMethods` - 支付方式管理
- `settings/vendors` - 供应商管理
- `settings/users` - 用户管理
- `assets/list` - 资产列表
- `assets/create` - 创建资产
- `assets/view` - 资产详情
- `assets/void` - 作废资产
- `assets/export` - 导出资产
- `assets/import` - 导入资产
- `materials/list` - 材料列表
- `materials/create` - 创建/入库材料
- `drinks/recipes` - 饮品配方管理
- `drinks/consume` - 饮品消耗
- `inspections/list` - 检查列表
- `inspections/create` - 创建检查
- `inspections/view` - 检查详情
- `inspections/review` - 审核检查

### API 路由（通过 `/api.php?r=controller/action`）

- `transaction/list` - 获取交易列表
- `transaction/view` - 获取交易详情
- `transaction/create` - 创建交易
- `transaction/void` - 作废交易
- `inspection/list` - 获取检查列表
- `inspection/view` - 获取检查详情
- `inspection/create` - 创建检查
- `inspection/review` - 审核检查

---

## 八、总结

这是一个功能完整、架构清晰的多模块管理系统。系统不仅包含基础的财务管理功能，还扩展了资产管理、材料管理、饮品管理、检查管理等业务模块，适合咖啡店、餐厅等小型商户使用。

### 系统特点：
1. **功能全面**：涵盖财务、资产、材料、饮品、检查等多个业务领域
2. **权限完善**：基于角色的访问控制，不同角色有不同权限
3. **安全可靠**：完善的 SQL 注入、XSS、CSRF 防护
4. **国际化**：支持中越双语
5. **API 支持**：提供 RESTful API 接口
6. **文件管理**：支持图片上传和附件管理
7. **数据统计**：提供丰富的统计报表功能

### 技术栈：
- **后端**：PHP 7.4+ (原生 PHP，MVC 架构)
- **数据库**：MySQL 5.7+ / MariaDB
- **前端**：HTML5, CSS3, JavaScript (原生)
- **安全**：PDO, CSRF Token, Password Hash

---

*最后更新：2024年*


