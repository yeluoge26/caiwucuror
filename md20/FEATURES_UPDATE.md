# 功能更新说明

## 📋 更新内容

本次更新实现了以下功能：

### 1. ✅ 财务数据导出功能

**实现位置**: `app/controllers/ExportController.php`

**功能**:
- **Excel导出** (`/index.php?r=export/excel`): 导出为HTML格式的Excel文件（.xls）
- **CSV导出** (`/index.php?r=export/csv`): 导出为CSV格式文件，支持中文显示

**特性**:
- 支持按当前筛选条件导出
- 导出所有字段（ID、类型、金额、货币、分类、支付方式、供应商、时间、备注、状态、创建人）
- 自动使用当前语言显示
- 文件名包含日期：`transactions_YYYY-MM-DD.xls` 或 `.csv`

**使用方法**:
在交易列表页面点击"导出 Excel"或"导出 CSV"按钮

---

### 2. ✅ 财务数据导入功能

**实现位置**: 
- 控制器: `app/controllers/ImportController.php`
- 视图: `app/views/import/index.php`

**功能**:
- 支持从CSV文件导入交易数据
- 自动匹配分类、支付方式、供应商
- 显示导入成功和失败数量

**特性**:
- 权限控制：仅 owner、manager、accountant 可导入
- 自动匹配：根据名称匹配分类、支付方式、供应商
- 错误处理：显示导入失败数量
- 模板下载：可下载模板文件

**使用方法**:
1. 访问 `/index.php?r=import/index`
2. 下载模板文件（可选）
3. 填写数据后上传CSV文件
4. 系统自动导入并显示结果

**CSV格式要求**:
```
ID,类型,金额,货币,分类,支付方式,供应商,时间,备注,状态
```

---

### 3. ✅ 交易编辑功能

**实现位置**:
- 控制器方法: `TransactionController::edit()`
- 视图: `app/views/transactions/edit.php`

**功能**:
- 允许编辑已创建的交易（owner、manager、accountant权限）
- 不能编辑已作废的交易
- 编辑后自动跳转到详情页

**使用方法**:
- 在交易列表或详情页点击"编辑"按钮
- 修改信息后保存

---

### 4. ✅ 交易审核功能

**实现位置**:
- 控制器方法: `TransactionController::approve()`
- 视图: `app/views/transactions/approve.php`

**功能**:
- 将待审核（pending）状态的交易审核通过（approved）
- 权限：owner、manager、accountant
- 审核后自动跳转到详情页

**使用方法**:
- 在交易列表或详情页，如果交易状态为"待审核"，会显示"审核通过"按钮
- 点击后确认审核

---

### 5. ✅ 移动端界面优化

**优化位置**: `app/views/layout/header.php`

**改进内容**:
- **响应式设计增强**:
  - 768px以下：优化导航栏布局，改为垂直排列
  - 480px以下：进一步压缩间距和字体
  - 表格横向滚动：小屏幕下表格可横向滚动
  - 字体大小优化：防止iOS自动缩放（表单输入框16px）
  
- **移动端优化**:
  - 按钮大小适配触摸操作
  - 导航菜单在小屏幕下全宽显示
  - 卡片内边距自适应
  - KPI数字大小自适应

---

### 6. ✅ 修复保存后自动跳转问题

**修复位置**: `app/controllers/SettingController.php`

**问题**:
- 设置页面（分类、支付方式、供应商）保存后没有显示成功消息

**解决方案**:
- 使用Session存储成功消息
- 保存后跳转并显示成功提示
- 所有设置页面统一处理

**影响的页面**:
- 分类管理 (`/index.php?r=settings/categories`)
- 支付方式管理 (`/index.php?r=settings/paymentMethods`)
- 供应商管理 (`/index.php?r=settings/vendors`)

---

### 7. ✅ 语言包更新

**更新文件**:
- `lang/zh.php` (中文)
- `lang/vi.php` (越南语)

**新增翻译**:
- 导出/导入相关：`btn.export`, `btn.import`, `import.*`
- 审核相关：`tx.approve`, `tx.approve_confirm`
- 更新失败：`tx.update_failed`

---

## 🎯 使用指南

### 导出数据

1. 进入交易列表页面
2. 使用筛选条件（可选）
3. 点击"导出 Excel"或"导出 CSV"按钮
4. 文件自动下载

### 导入数据

1. 进入导入页面：`/index.php?r=import/index`
2. 点击"下载模板"获取CSV模板（可选）
3. 填写数据（注意格式）
4. 选择文件并上传
5. 查看导入结果

### 编辑交易

1. 在交易列表或详情页点击"编辑"按钮
2. 修改信息
3. 点击"保存"
4. 自动跳转到详情页

### 审核交易

1. 找到状态为"待审核"的交易
2. 点击"审核通过"按钮
3. 确认审核
4. 状态自动变为"已审核"

---

## 🔧 技术细节

### 导出实现

- **Excel格式**: 使用HTML表格格式，浏览器识别为Excel
- **CSV格式**: 使用UTF-8 BOM确保Excel正确显示中文
- **数据过滤**: 支持所有列表页面的筛选条件

### 导入实现

- **文件验证**: 仅接受CSV格式
- **数据匹配**: 使用名称映射匹配分类、支付方式、供应商
- **错误处理**: 记录导入失败数量

### 权限控制

- **导出**: 所有登录用户
- **导入**: owner、manager、accountant
- **编辑**: owner、manager、accountant
- **审核**: owner、manager、accountant
- **作废**: owner、accountant

---

## 📝 注意事项

1. **导入格式**: CSV文件必须严格按照模板格式，否则可能导入失败
2. **数据匹配**: 导入时分类、支付方式名称必须与系统中已有的完全一致（支持中越双语）
3. **移动端**: 建议在移动设备上测试，确保界面正常显示
4. **权限**: 确保用户角色权限设置正确

---

## 🐛 已知问题

1. CSV导入时，如果分类或支付方式名称不完全匹配，会导入失败
2. Excel导出格式为HTML，某些Excel版本可能需要手动设置编码

---

## 🔄 后续优化建议

1. 支持Excel格式导入（.xlsx）
2. 导入时支持自动创建不存在的分类/支付方式
3. 导出时支持选择导出字段
4. 添加导入预览功能
5. 优化移动端表格显示（卡片式布局）

---

**更新日期**: 2024年
**版本**: v1.1.0

