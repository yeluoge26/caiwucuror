# 系统完整功能清单

> 最后更新：2024年12月

## 📋 项目概述

这是一个完整的店内管理系统，适用于咖啡店、餐厅等小型商户。系统采用原生 PHP 开发，MVC 架构，支持中越双语。

**技术栈：**
- 后端：PHP 7.4+ (原生 PHP，无框架)
- 数据库：MySQL 5.7+ / MariaDB
- 前端：HTML5, CSS3, JavaScript (原生)
- 架构：MVC 模式
- 国际化：支持中文、越南语

---

## 🔐 一、用户认证与权限管理

### 1.1 用户认证 (AuthController)

**路由：** `auth/login`, `auth/logout`

**功能：**
- ✅ 用户登录（用户名/密码）
- ✅ 用户登出
- ✅ Session 管理
- ✅ 密码加密存储（password_hash）
- ✅ 登录状态保持

**权限：** 所有用户

**实现文件：**
- `app/core/Auth.php` - 认证核心类
- `app/controllers/AuthController.php` - 登录控制器
- `app/models/User.php` - 用户模型

---

### 1.2 角色权限系统 (RBAC)

**角色类型：**
1. **Owner（老板）**
   - 全权限
   - 查看所有统计
   - 删除/作废记录
   - 系统设置管理

2. **Manager（店长）**
   - 录入、查看、审批
   - 管理员工和班次
   - 创建任务

3. **Accountant（财务）**
   - 录入、审核、导出
   - 查看报表统计
   - 数据导入导出

4. **Staff（员工）**
   - 只能新增记录
   - 不能删除
   - 只能看自己提交的记录

**权限验证：**
- `Auth::requireLogin()` - 要求登录
- `Auth::requireRole(['owner', 'manager'])` - 要求特定角色

---

## 💰 二、交易管理模块

### 2.1 交易创建 (TransactionController::create)

**路由：** `transactions/create`

**功能：**
- ✅ 创建收入/支出交易
- ✅ 选择分类（支持二级分类）
- ✅ 选择支付方式
- ✅ 选择供应商（可选）
- ✅ 设置金额、货币（VND/USD等）
- ✅ 设置发生时间
- ✅ 添加备注
- ✅ 上传凭证图片（最多5张，每张5MB）
- ✅ CSRF 防护

**权限：** 所有登录用户

**数据字段：**
- type: income/expense
- amount: 金额（必须为正数）
- currency: 货币类型
- category_id: 分类ID
- payment_method_id: 支付方式ID
- vendor_id: 供应商ID（可选）
- occurred_at: 发生时间
- note: 备注
- status: pending（待审核）

---

### 2.2 交易列表 (TransactionController::list)

**路由：** `transactions/list`

**功能：**
- ✅ 分页显示（每页50条）
- ✅ 多条件筛选：
  - 类型（收入/支出）
  - 日期范围（从/到）
  - 分类
  - 支付方式
  - 创建人
  - 状态（待审核/已审核/已作废）
  - 关键词搜索（备注、供应商）
- ✅ 按发生时间倒序排列
- ✅ 显示交易摘要信息
- ✅ 快速操作（查看、编辑、作废）

**权限：** 所有登录用户（员工只能看自己的）

---

### 2.3 交易详情 (TransactionController::view)

**路由：** `transactions/view`

**功能：**
- ✅ 查看单笔交易的完整信息
- ✅ 显示关联的分类、支付方式、供应商
- ✅ 显示创建人、创建时间
- ✅ 查看附件（图片）
- ✅ 查看作废请求记录
- ✅ 显示审核状态和审核人

**权限：** 所有登录用户

---

### 2.4 交易编辑 (TransactionController::edit)

**路由：** `transactions/edit`

**功能：**
- ✅ 编辑交易信息（仅限待审核状态）
- ✅ 修改金额、分类、支付方式等
- ✅ 更新附件
- ✅ 修改后状态重置为待审核

**权限：** 创建人或老板/财务

---

### 2.5 交易审核 (TransactionController::approve)

**路由：** `transactions/approve`

**功能：**
- ✅ 审核交易（pending → approved）
- ✅ 添加审核备注
- ✅ 记录审核人和审核时间

**权限：** Owner, Manager, Accountant

---

### 2.6 交易作废 (TransactionController::void)

**路由：** `transactions/void`

**功能：**
- ✅ 作废交易（status → void）
- ✅ 作废的交易不会出现在统计中
- ✅ 记录作废原因

**权限：** Owner, Accountant

---

### 2.7 申请作废 (TransactionController::requestVoid)

**路由：** `transactions/requestVoid`

**功能：**
- ✅ 员工可以申请作废交易
- ✅ 需要填写作废原因
- ✅ 等待审批

**权限：** 所有用户（员工只能申请自己创建的）

---

### 2.8 交易导出 (ExportController)

**路由：** `export/excel`, `export/csv`

**功能：**
- ✅ Excel 导出（HTML格式）
- ✅ CSV 导出（UTF-8 BOM，支持中文）
- ✅ 按筛选条件导出
- ✅ 默认只导出已审核的交易

**权限：** Owner, Manager, Accountant

---

### 2.9 交易导入 (ImportController)

**路由：** `import/index`

**功能：**
- ✅ CSV 文件导入
- ✅ 自动匹配分类（支持中越双语）
- ✅ 自动匹配支付方式（支持中越双语）
- ✅ 自动匹配供应商
- ✅ 导入结果统计（成功/失败数量）
- ✅ 导入的交易自动设为已审核

**权限：** Owner, Manager, Accountant

**CSV 格式：**
```csv
type,amount,currency,category_zh,category_vi,payment_method_zh,payment_method_vi,vendor_name,payer,occurred_at,note
income,100000,VND,堂食收入,Doanh thu tại chỗ,现金,Tiền mặt,,顾客A,2024-07-20 10:00:00,咖啡销售
```

---

## 📊 三、报表统计模块

### 3.1 Dashboard 仪表盘 (ReportController::dashboard)

**路由：** `reports/dashboard`

**功能：**
- ✅ 今日统计：今日收入/支出总额
- ✅ 本月统计：本月收入/支出总额
- ✅ 7天趋势：最近7天的收入/支出趋势图
- ✅ 最近10笔流水：最新交易记录
- ✅ 快速操作链接

**权限：** 所有登录用户

---

### 3.2 汇总统计 API (ReportController::summary)

**路由：** `reports/summary` (API)

**功能：**
- ✅ 支持时间范围：今天、最近7天、本月
- ✅ 返回 JSON 格式的收入/支出汇总
- ✅ 计算净收入（收入-支出）

**权限：** 所有登录用户

---

### 3.3 分类统计 API (ReportController::byCategory)

**路由：** `reports/byCategory` (API)

**功能：**
- ✅ 按分类统计收入/支出
- ✅ 支持按类型筛选（收入/支出）
- ✅ 支持时间范围筛选
- ✅ 返回 JSON 格式数据

**权限：** 所有登录用户

---

### 3.4 高级报表 (AdvancedReportController)

**路由：** `reports/advanced`

**功能：**
- ✅ 多时间范围选择（今天/本周/本月/本年/自定义）
- ✅ 趋势分析（按天统计）
- ✅ 分类统计（饼图/柱状图）
- ✅ 支付方式统计
- ✅ 供应商统计（支出）
- ✅ 月度对比（最近3个月）
- ✅ 图表数据 API (`reports/chartData`)

**权限：** 所有登录用户

---

## ⚙️ 四、设置管理模块

### 4.1 分类管理 (SettingController::categories)

**路由：** `settings/categories`

**功能：**
- ✅ 分类列表（支持一级/二级分类）
- ✅ 创建分类（收入/支出/两者）
- ✅ 编辑分类
- ✅ 删除分类（软删除）
- ✅ 中越双语名称
- ✅ 分类状态管理（启用/禁用）

**权限：** Owner, Manager, Accountant

**分类类型：**
- income: 仅收入
- expense: 仅支出
- both: 收入/支出均可

---

### 4.2 支付方式管理 (SettingController::paymentMethods)

**路由：** `settings/payment_methods`

**功能：**
- ✅ 支付方式列表
- ✅ 创建支付方式
- ✅ 编辑支付方式
- ✅ 删除支付方式（软删除）
- ✅ 中越双语名称
- ✅ 状态管理（启用/禁用）

**权限：** Owner, Manager, Accountant

---

### 4.3 供应商管理 (SettingController::vendors)

**路由：** `settings/vendors`

**功能：**
- ✅ 供应商列表
- ✅ 创建供应商
- ✅ 编辑供应商
- ✅ 删除供应商（软删除）
- ✅ 供应商信息（名称、联系方式、地址）
- ✅ 状态管理（启用/禁用）

**权限：** Owner, Manager, Accountant

---

### 4.4 用户管理 (SettingController::users)

**路由：** `settings/users`

**功能：**
- ✅ 用户列表
- ✅ 创建用户（设置角色、初始密码）
- ✅ 编辑用户（修改信息、角色、状态）
- ✅ 删除用户（软删除）
- ✅ 用户状态管理（启用/禁用）
- ✅ 密码重置

**权限：** Owner

---

## 📦 五、资产管理模块

### 5.1 资产创建 (AssetsController::create)

**路由：** `assets/create`

**功能：**
- ✅ 创建资产记录
- ✅ 资产信息（名称、类型、价值、购买日期等）
- ✅ 上传资产图片
- ✅ 资产状态（在用/闲置/报废）

**权限：** Owner, Manager, Accountant

---

### 5.2 资产列表 (AssetsController::list)

**路由：** `assets/list`

**功能：**
- ✅ 资产列表（分页）
- ✅ 筛选（类型、状态）
- ✅ 搜索（名称、编号）
- ✅ 查看资产详情

**权限：** Owner, Manager, Accountant

---

### 5.3 资产详情 (AssetsController::view)

**路由：** `assets/view`

**功能：**
- ✅ 查看资产完整信息
- ✅ 查看资产附件
- ✅ 资产历史记录

**权限：** Owner, Manager, Accountant

---

### 5.4 资产作废 (AssetsController::void)

**路由：** `assets/void`

**功能：**
- ✅ 作废资产
- ✅ 记录作废原因

**权限：** Owner, Manager

---

## 📦 六、材料管理模块

### 6.1 材料创建 (MaterialsController::create)

**路由：** `materials/create`

**功能：**
- ✅ 创建材料记录
- ✅ 材料信息（名称、单位、库存数量等）
- ✅ 上传材料图片
- ✅ 材料分类

**权限：** Owner, Manager, Accountant

---

### 6.2 材料列表 (MaterialsController::list)

**路由：** `materials/list`

**功能：**
- ✅ 材料列表（分页）
- ✅ 筛选（分类、状态）
- ✅ 搜索（名称）
- ✅ 库存预警

**权限：** Owner, Manager, Accountant

---

## 🍹 七、饮品管理模块

### 7.1 饮品配方管理 (DrinksController::recipes)

**路由：** `drinks/recipes`

**功能：**
- ✅ 饮品配方列表
- ✅ 创建配方
- ✅ 编辑配方
- ✅ 配方包含的材料和用量
- ✅ 计算成本

**权限：** Owner, Manager, Accountant

---

### 7.2 饮品消耗记录 (DrinksController::consume)

**路由：** `drinks/consume`

**功能：**
- ✅ 记录饮品制作
- ✅ 自动扣减材料库存
- ✅ 消耗记录列表

**权限：** Owner, Manager, Accountant

---

## 🔍 八、检查管理模块

### 8.1 检查创建 (InspectionsController::create)

**路由：** `inspections/create`

**功能：**
- ✅ 创建检查记录
- ✅ 检查类型（日常检查/专项检查）
- ✅ 检查项目
- ✅ 上传检查照片
- ✅ 检查结果（通过/不通过/待整改）

**权限：** Owner, Manager, Accountant

---

### 8.2 检查列表 (InspectionsController::list)

**路由：** `inspections/list`

**功能：**
- ✅ 检查记录列表（分页）
- ✅ 筛选（类型、结果、日期）
- ✅ 搜索
- ✅ 查看检查详情

**权限：** Owner, Manager, Accountant

---

### 8.3 检查详情 (InspectionsController::view)

**路由：** `inspections/view`

**功能：**
- ✅ 查看检查完整信息
- ✅ 查看检查照片
- ✅ 检查历史记录

**权限：** Owner, Manager, Accountant

---

## ✅ 九、任务管理模块

### 9.1 任务列表 (TaskController::list)

**路由：** `tasks/list`

**功能：**
- ✅ 任务列表（分页）
- ✅ 筛选（类型、状态、指派对象）
- ✅ 搜索（标题、描述）
- ✅ 任务状态：待开始/进行中/已完成/已审批/已拒绝

**权限：** 所有登录用户

---

### 9.2 任务创建 (TaskController::create)

**路由：** `tasks/create`

**功能：**
- ✅ 创建任务
- ✅ 任务标题
- ✅ 任务类型（固定/临时）
- ✅ 描述说明
- ✅ 截止时间
- ✅ 关联门店/区域（未来可扩展）
- ✅ 指派角色或具体用户
- ✅ 是否需要拍照/上传附件
- ✅ 关联罚款/奖励金额
- ✅ 上传附件

**权限：** Owner, Manager

---

### 9.3 任务详情 (TaskController::view)

**路由：** `tasks/view`

**功能：**
- ✅ 查看任务完整信息
- ✅ 查看任务附件
- ✅ 查看完成说明和审批说明
- ✅ 任务操作（开始、完成、审批）

**权限：** 所有登录用户

---

### 9.4 任务完成 (TaskController::complete)

**路由：** `tasks/complete`

**功能：**
- ✅ 完成任务
- ✅ 填写完成说明
- ✅ 上传完成照片/附件
- ✅ 状态变为"已完成"，等待审批

**权限：** 被指派的用户

---

### 9.5 任务审批 (TaskController::approve)

**路由：** `tasks/approve`

**功能：**
- ✅ 审批任务（通过/拒绝）
- ✅ 填写审批说明
- ✅ 如果通过，状态变为"已审批"
- ✅ 如果拒绝，状态变为"已拒绝"

**权限：** Owner

---

### 9.6 任务开始 (TaskController::start)

**路由：** `tasks/start`

**功能：**
- ✅ 开始任务
- ✅ 状态从"待开始"变为"进行中"

**权限：** 被指派的用户

---

## 👥 十、员工管理模块

### 10.1 员工列表 (EmployeeController::list)

**路由：** `employees/list`

**功能：**
- ✅ 员工列表（分页，每页20条）
- ✅ 筛选（状态、角色）
- ✅ 搜索（姓名、电话、邮箱）
- ✅ 显示员工基本信息（姓名、角色、雇佣类型、联系方式、状态）

**权限：** Owner, Manager, Accountant

---

### 10.2 员工创建 (EmployeeController::create)

**路由：** `employees/create`

**功能：**
- ✅ 创建员工档案
- ✅ 姓名（必填）
- ✅ 角色（关联系统角色表）
- ✅ 联系电话
- ✅ 邮箱
- ✅ 地址
- ✅ 雇佣类型（全职/兼职）⭐
- ✅ 状态（在职/离职/已辞职）
- ✅ 入职时间
- ✅ 离职时间（可选）
- ✅ 备注

**权限：** Owner, Manager

---

### 10.3 员工编辑 (EmployeeController::edit)

**路由：** `employees/edit`

**功能：**
- ✅ 编辑员工信息
- ✅ 修改所有字段
- ✅ 更新状态

**权限：** Owner, Manager

---

### 10.4 员工详情 (EmployeeController::view)

**路由：** `employees/view`

**功能：**
- ✅ 查看员工完整信息
- ✅ 显示所有字段
- ✅ 快速编辑链接

**权限：** Owner, Manager, Accountant

---

## 📅 十一、班次管理模块

### 11.1 班次列表 (ShiftController::list)

**路由：** `shifts/list`

**功能：**
- ✅ 班次列表（分页，每页50条）
- ✅ 筛选（日期、班次类型、员工、到岗确认状态）
- ✅ 显示班次信息（日期、类型、员工、负责人、确认状态）
- ✅ 快速确认到岗按钮

**权限：** Owner, Manager, Accountant

---

### 11.2 班次创建 (ShiftController::create)

**路由：** `shifts/create`

**功能：**
- ✅ 创建单个班次
- ✅ 日期（必填）
- ✅ 班次类型（早班/中班/晚班）
- ✅ 员工（必填，从在职员工中选择）
- ✅ 负责人（可选，从老板/店长中选择）
- ✅ 备注

**权限：** Owner, Manager

---

### 11.3 排班功能 (ShiftController::schedule)

**路由：** `shifts/schedule`

**功能：**
- ✅ 选择日期进行排班
- ✅ 批量添加班次
- ✅ 动态添加/删除班次行
- ✅ 自动检测并更新已存在的班次
- ✅ 支持同一天同一员工多个班次（早中晚）

**权限：** Owner, Manager

---

### 11.4 到岗确认 (ShiftController::confirm)

**路由：** `shifts/confirm`, `shifts/quickConfirm`

**功能：**
- ✅ 快速确认（在列表中直接点击确认）
- ✅ 取消确认
- ✅ 记录确认时间和确认人
- ✅ 状态标识（已到岗/未确认）

**权限：** Owner, Manager

---

## 🌐 十二、国际化支持

### 12.1 多语言支持

**支持语言：**
- 中文（zh）
- 越南语（vi）

**实现：**
- `app/core/I18n.php` - 国际化核心类
- `lang/zh.php` - 中文语言包
- `lang/vi.php` - 越南语语言包

**功能：**
- ✅ 自动检测语言（Session/Cookie）
- ✅ 语言切换
- ✅ 所有界面文本国际化
- ✅ 数据字段国际化（分类、支付方式等）

---

## 🔒 十三、安全特性

### 13.1 认证安全

- ✅ 密码加密（password_hash）
- ✅ Session 管理
- ✅ 登录状态验证
- ✅ 自动登出（Session过期）

---

### 13.2 权限控制

- ✅ 基于角色的访问控制（RBAC）
- ✅ 路由级权限验证
- ✅ 操作级权限验证
- ✅ 数据级权限验证（员工只能看自己的记录）

---

### 13.3 数据安全

- ✅ CSRF 防护（所有表单）
- ✅ SQL 注入防护（PDO 预处理）
- ✅ XSS 防护（htmlspecialchars）
- ✅ 文件上传验证（类型、大小）

---

## 📱 十四、移动端支持

### 14.1 响应式设计

- ✅ 移动端适配
- ✅ 触摸友好
- ✅ 图片上传优化
- ✅ 表单输入优化

---

## 🔌 十五、API 接口

### 15.1 认证 API (AuthApiController)

**路由：** `api/auth/login`, `api/auth/logout`

**功能：**
- ✅ API Token 认证
- ✅ 登录接口
- ✅ 登出接口

---

### 15.2 交易 API (TransactionApiController)

**路由：** `api/transactions/*`

**功能：**
- ✅ 创建交易
- ✅ 查询交易列表
- ✅ 查询交易详情
- ✅ 更新交易
- ✅ 删除交易

---

### 15.3 检查 API (InspectionApiController)

**路由：** `api/inspections/*`

**功能：**
- ✅ 创建检查
- ✅ 查询检查列表
- ✅ 查询检查详情
- ✅ 上传检查照片

---

## 📊 十六、数据表结构

### 核心表

1. **users** - 用户表
2. **roles** - 角色表
3. **categories** - 分类表（支持二级分类）
4. **payment_methods** - 支付方式表
5. **vendors** - 供应商表

### 业务表

6. **transactions** - 交易表
7. **attachments** - 附件表
8. **void_requests** - 作废请求表
9. **assets** - 资产表
10. **asset_attachments** - 资产附件表
11. **materials** - 材料表
12. **material_attachments** - 材料附件表
13. **drinks** - 饮品表
14. **drink_recipes** - 饮品配方表
15. **consumption_logs** - 消耗记录表
16. **inspections** - 检查表
17. **inspection_photos** - 检查照片表
18. **tasks** - 任务表
19. **task_attachments** - 任务附件表
20. **employees** - 员工表 ⭐
21. **shifts** - 班次表 ⭐

---

## 🎯 功能统计

### 模块数量
- 核心模块：2个（认证、权限）
- 业务模块：10个（交易、报表、设置、资产、材料、饮品、检查、任务、员工、班次）
- 支持模块：3个（国际化、安全、移动端）

### 控制器数量
- 15个控制器
- 3个API控制器

### 数据表数量
- 21个数据表

### 功能点总数
- 约 80+ 个功能点

---

## 📝 路由清单

### 认证路由
- `auth/login` - 登录
- `auth/logout` - 登出

### 交易路由
- `transactions/create` - 创建交易
- `transactions/list` - 交易列表
- `transactions/view` - 交易详情
- `transactions/edit` - 编辑交易
- `transactions/approve` - 审核交易
- `transactions/void` - 作废交易
- `transactions/requestVoid` - 申请作废

### 报表路由
- `reports/dashboard` - 仪表盘
- `reports/summary` - 汇总统计（API）
- `reports/byCategory` - 分类统计（API）
- `reports/advanced` - 高级报表
- `reports/chartData` - 图表数据（API）

### 设置路由
- `settings/categories` - 分类管理
- `settings/payment_methods` - 支付方式管理
- `settings/vendors` - 供应商管理
- `settings/users` - 用户管理

### 资产路由
- `assets/create` - 创建资产
- `assets/list` - 资产列表
- `assets/view` - 资产详情
- `assets/void` - 作废资产

### 材料路由
- `materials/create` - 创建材料
- `materials/list` - 材料列表

### 饮品路由
- `drinks/recipes` - 配方管理
- `drinks/consume` - 消耗记录

### 检查路由
- `inspections/create` - 创建检查
- `inspections/list` - 检查列表
- `inspections/view` - 检查详情

### 任务路由
- `tasks/list` - 任务列表
- `tasks/create` - 创建任务
- `tasks/view` - 任务详情
- `tasks/start` - 开始任务
- `tasks/complete` - 完成任务
- `tasks/approve` - 审批任务

### 员工路由
- `employees/list` - 员工列表
- `employees/create` - 创建员工
- `employees/edit` - 编辑员工
- `employees/view` - 员工详情

### 班次路由
- `shifts/list` - 班次列表
- `shifts/create` - 创建班次
- `shifts/schedule` - 排班
- `shifts/confirm` - 确认到岗
- `shifts/quickConfirm` - 快速确认

### 导出导入路由
- `export/excel` - Excel导出
- `export/csv` - CSV导出
- `import/index` - CSV导入

### API路由
- `api/auth/login` - API登录
- `api/auth/logout` - API登出
- `api/transactions/*` - 交易API
- `api/inspections/*` - 检查API

---

## 🎨 界面特性

### UI/UX
- ✅ 现代化卡片式设计
- ✅ 响应式布局
- ✅ 移动端优化
- ✅ 直观的导航菜单
- ✅ 友好的错误提示
- ✅ 成功操作反馈

### 交互特性
- ✅ 分页导航
- ✅ 多条件筛选
- ✅ 实时搜索
- ✅ 批量操作（部分功能）
- ✅ 文件上传预览
- ✅ 表单验证

---

## 🔄 数据流程

### 交易流程
1. 创建交易 → 待审核（pending）
2. 审核交易 → 已审核（approved）
3. 作废交易 → 已作废（void）

### 任务流程
1. 创建任务 → 待开始（pending）
2. 开始任务 → 进行中（in_progress）
3. 完成任务 → 已完成（completed）
4. 审批任务 → 已审批（approved）/ 已拒绝（rejected）

### 班次流程
1. 创建班次 → 未确认
2. 确认到岗 → 已确认

---

## 📈 性能特性

- ✅ 数据库索引优化
- ✅ 分页查询
- ✅ 条件筛选优化
- ✅ 文件上传大小限制
- ✅ 图片压缩（部分功能）

---

## 🛠️ 开发特性

### 代码组织
- ✅ MVC 架构
- ✅ 单一职责原则
- ✅ 代码复用
- ✅ 统一错误处理

### 可维护性
- ✅ 清晰的代码结构
- ✅ 注释完善
- ✅ 统一的命名规范
- ✅ 模块化设计

---

*本文档持续更新中...*

