# 分类和供应商修复说明

## 问题描述

1. **支出分类问题**：创建支出交易时，分类选择可能不显示支出分类
2. **供应商缺失**：供应商表为空，创建支出交易时无法选择供应商

## 修复内容

### 1. 添加默认供应商数据 ✅

已在数据库中添加了 5 个默认供应商：

| ID | 供应商名称 | 电话 | 备注 |
|----|----------|------|------|
| 1 | 食材供应商A | 0123456789 | 主要食材供应商 |
| 2 | 设备维修公司 | 0987654321 | 设备维护和维修 |
| 3 | 水电公司 | 0111222333 | 水电费缴纳 |
| 4 | 广告公司 | 0444555666 | 营销推广服务 |
| 5 | 其他供应商 | NULL | 其他支出供应商 |

### 2. 修复分类选择逻辑 ✅

**问题**：
- 创建交易时，如果默认选择"收入"，支出分类不会显示
- 切换交易类型时，分类选择没有正确更新

**修复**：
- 改进了 JavaScript 分类过滤逻辑
- 当切换交易类型时，自动过滤显示对应的分类
- 如果当前选中的分类不在新类型中，自动清空选择
- 添加了 `id="category-select"` 以便 JavaScript 正确操作

### 3. 更新数据库结构文件 ✅

已更新 `database/schema.sql`，包含默认供应商数据，确保以后安装时自动包含这些数据。

## 当前分类数据

### 收入分类（4个）
1. 堂食收入 / Doanh thu tại chỗ
2. 外卖收入 / Doanh thu giao hàng
3. 团购收入 / Doanh thu nhóm
4. 其他收入 / Thu nhập khác

### 支出分类（6个）
1. 食材采购 / Mua nguyên liệu
2. 设备维护 / Bảo trì thiết bị
3. 房租水电 / Tiền thuê nhà và điện nước
4. 员工工资 / Lương nhân viên
5. 营销推广 / Marketing và quảng cáo
6. 其他支出 / Chi phí khác

## 功能改进

### 创建交易页面

1. **分类动态过滤**：
   - 选择"收入"时，只显示收入分类和通用分类
   - 选择"支出"时，只显示支出分类和通用分类
   - 切换类型时自动更新分类选项

2. **供应商选择**：
   - 选择"支出"时，自动显示供应商选择字段
   - 选择"收入"时，自动隐藏供应商字段
   - 切换类型时自动清空供应商选择

## 验证方法

### 1. 检查供应商数据
```bash
mysql -u root coffee_finance -e "SELECT * FROM vendors;"
```

### 2. 检查分类数据
```bash
mysql -u root coffee_finance -e "SELECT id, type, name_zh, name_vi FROM categories WHERE is_active = 1;"
```

### 3. 测试创建交易
1. 访问：http://localhost:8000/index.php?r=transactions/create
2. 选择"支出"类型
3. 验证：
   - 分类下拉框只显示支出分类（6个）
   - 供应商字段显示，可以选择供应商（5个选项）
4. 切换到"收入"类型
5. 验证：
   - 分类下拉框只显示收入分类（4个）
   - 供应商字段隐藏

## 数据库更新

如果已有数据库，需要手动插入供应商数据：

```sql
INSERT INTO vendors(name, phone, note, is_active) VALUES
('食材供应商A', '0123456789', '主要食材供应商', 1),
('设备维修公司', '0987654321', '设备维护和维修', 1),
('水电公司', '0111222333', '水电费缴纳', 1),
('广告公司', '0444555666', '营销推广服务', 1),
('其他供应商', NULL, '其他支出供应商', 1)
ON DUPLICATE KEY UPDATE name=VALUES(name), phone=VALUES(phone), note=VALUES(note);
```

## 修改的文件

1. ✅ `database/schema.sql` - 添加默认供应商数据
2. ✅ `app/views/transactions/create.php` - 修复分类选择逻辑和 JavaScript

## 注意事项

- 供应商数据已添加到现有数据库
- 新安装系统时会自动包含默认供应商
- 可以通过设置页面管理供应商（添加、编辑、删除）

---

**修复时间**: 2025-12-13
**状态**: ✅ 已修复并验证

