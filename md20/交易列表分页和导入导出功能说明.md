# 交易列表分页和导入导出功能说明

## 功能概述

已为交易列表添加了以下功能：
1. **分页功能** - 每页显示50条记录，支持翻页导航
2. **导出功能** - 将交易数据导出为CSV文件
3. **导入功能** - 从CSV文件批量导入交易数据

---

## 一、分页功能

### 功能特点
- 每页显示 **50条** 记录
- 支持筛选条件的分页（筛选条件会保留在分页链接中）
- 显示总记录数和总页数
- 提供首页、上一页、下一页、末页导航

### 实现位置
- `app/models/Transaction.php` - 添加了 `count()` 方法用于统计总数
- `app/models/Transaction.php` - 更新了 `list()` 方法支持 `offset` 参数
- `app/controllers/TransactionController.php` - 更新了 `list()` 方法添加分页逻辑
- `app/views/transactions/list.php` - 添加了分页控件UI

### 使用方法
访问交易列表页面，系统会自动显示分页控件。可以通过分页按钮或直接修改URL中的 `page` 参数来切换页面。

---

## 二、导出功能

### 功能特点
- 支持按筛选条件导出（导出当前筛选结果）
- 导出格式为CSV，兼容Excel
- 支持中越双语表头
- 导出格式与导入格式一致，便于再次导入

### 权限要求
- 仅限 **老板(owner)**、**店长(manager)**、**财务(accountant)** 角色使用

### 导出字段
CSV文件包含以下字段：
- 类型（收入/支出）
- 金额
- 货币
- 分类
- 支付方式
- 供应商（可选）
- 付款人（可选）
- 发生时间
- 备注

### 使用方法
1. 在交易列表页面，点击 **"导出"** 按钮
2. 系统会根据当前的筛选条件导出数据
3. 下载的CSV文件名为：`transactions_YYYYMMDD_HHMMSS.csv`

---

## 三、导入功能

### 功能特点
- 支持批量导入交易数据
- 自动匹配分类和支付方式（支持中越双语名称）
- 支持类型字段使用中文、越南语或英文
- 自动验证数据格式
- 显示导入结果（成功/失败数量）

### 权限要求
- 仅限 **老板(owner)**、**店长(manager)**、**财务(accountant)** 角色使用

### CSV格式要求

#### 表头格式
```
类型,金额,货币,分类,支付方式,供应商,付款人,发生时间,备注
```

#### 数据格式示例
```
收入,500000,VND,堂食,现金,,,2024-12-14 10:30:00,早餐收入
支出,200000,VND,食材采购,现金,供应商A,,2024-12-14 09:00:00,购买咖啡豆
income,800000,VND,团购,VNPAY,,,2024-12-14 14:20:00,团购活动
expense,50000,VND,其他支出,现金,,,2024-12-14 16:00:00,杂项支出
```

#### 字段说明
- **类型**：必填，支持 `收入`/`支出`/`income`/`expense`/`Thu nhập`/`Chi tiêu`
- **金额**：必填，数字格式（支持千位分隔符，会自动去除）
- **货币**：可选，默认为 `VND`
- **分类**：必填，必须与系统中已有的分类名称匹配（支持中越双语）
- **支付方式**：必填，必须与系统中已有的支付方式名称匹配（支持中越双语）
- **供应商**：可选，如果填写必须与系统中已有的供应商名称匹配
- **付款人**：可选
- **发生时间**：可选，格式：`YYYY-MM-DD HH:MM:SS` 或 `YYYY-MM-DD`，默认为当前时间
- **备注**：可选

### 使用方法
1. 在交易列表页面，点击 **"示例"** 按钮下载示例CSV文件
2. 按照示例格式填写数据
3. 选择CSV文件，点击 **"导入"** 按钮
4. 系统会显示导入结果（成功/失败数量）

### 注意事项
- CSV文件必须使用UTF-8编码
- 分类和支付方式名称必须与系统中已有的完全匹配（区分大小写，但会自动转换为小写匹配）
- 供应商名称如果填写，必须与系统中已有的完全匹配
- 金额必须是正数
- 导入失败的数据不会影响已成功导入的数据

---

## 四、技术实现

### 修改的文件

1. **app/models/Transaction.php**
   - 添加 `count()` 方法：统计符合条件的交易总数
   - 更新 `list()` 方法：支持 `offset` 参数用于分页

2. **app/controllers/TransactionController.php**
   - 更新 `list()` 方法：添加分页逻辑
   - 添加 `export()` 方法：导出CSV文件
   - 添加 `import()` 方法：导入CSV文件

3. **app/views/transactions/list.php**
   - 添加导入导出按钮
   - 添加分页控件
   - 添加导入结果提示

4. **app/views/transactions/import_example.csv**
   - 创建导入示例文件

---

## 五、使用示例

### 分页示例
```
访问：/index.php?r=transactions/list&page=2
访问：/index.php?r=transactions/list&type=income&page=1
```

### 导出示例
```
访问：/index.php?r=transactions/export
访问：/index.php?r=transactions/export&type=income&from=2024-12-01
```

### 导入示例
```
POST /index.php?r=transactions/import
Content-Type: multipart/form-data
文件：transaction_csv (CSV文件)
```

---

## 六、注意事项

1. **分页**：
   - 分页会保留所有筛选条件
   - 每页默认显示50条，可在代码中修改 `$perPage` 变量

2. **导出**：
   - 导出时会应用当前的筛选条件
   - 导出大量数据时可能需要较长时间

3. **导入**：
   - 导入时会自动创建交易，状态为 `approved`
   - 导入的交易创建人为当前登录用户
   - 建议先使用少量数据测试导入功能

---

*最后更新：2024年12月*


