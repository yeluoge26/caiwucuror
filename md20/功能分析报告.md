# 财务管理系统 - 功能分析报告

## 项目概述

这是一个完整的店内收支管理系统，适用于咖啡店、餐厅等小型商户。系统采用原生 PHP 开发，MVC 架构，支持中越双语。

## 核心功能模块

### 1. 用户认证与权限管理 (AuthController)

**功能：**
- 用户登录/登出
- 基于角色的访问控制（RBAC）
- 四种角色：老板(owner)、店长(manager)、财务(accountant)、员工(staff)
- Session 管理
- 密码加密存储（password_hash）

**实现位置：**
- `app/core/Auth.php` - 认证核心类
- `app/controllers/AuthController.php` - 登录控制器
- `app/models/User.php` - 用户模型

**安全特性：**
- 密码使用 `password_hash()` 加密
- Session 存储用户信息
- 角色权限验证

### 2. 交易管理 (TransactionController)

**功能：**
- **创建交易** (`create`)
  - 支持收入/支出两种类型
  - 选择分类、支付方式、供应商
  - 设置金额、货币、发生时间、备注
  - CSRF 防护
  
- **交易列表** (`list`)
  - 支持多条件筛选：
    - 类型（收入/支出）
    - 日期范围（从/到）
    - 分类
    - 支付方式
    - 创建人
    - 关键词搜索（备注、供应商）
  - 分页显示（默认200条）
  - 按发生时间倒序排列

- **交易详情** (`view`)
  - 查看单笔交易的完整信息
  - 显示关联的分类、支付方式、供应商、创建人

- **交易作废** (`void`)
  - 仅限老板和财务角色操作
  - 将交易状态改为 'void'
  - 作废的交易不会出现在统计中

**实现位置：**
- `app/controllers/TransactionController.php`
- `app/models/Transaction.php`
- `app/views/transactions/`

**数据模型：**
- 交易表包含：类型、金额、货币、分类、支付方式、供应商、发生时间、备注、状态、创建人

### 3. 报表统计 (ReportController)

**功能：**
- **Dashboard 仪表盘** (`dashboard`)
  - 今日统计：今日收入/支出总额
  - 本月统计：本月收入/支出总额
  - 7天趋势：最近7天的收入/支出趋势图
  - 最近10笔流水：最新交易记录

- **汇总统计** (`summary`)
  - 支持时间范围：今天、最近7天、本月
  - 返回 JSON 格式的收入/支出汇总

- **分类统计** (`byCategory`)
  - 按分类统计收入/支出
  - 支持按类型筛选
  - 支持时间范围筛选

**实现位置：**
- `app/controllers/ReportController.php`
- `app/models/Transaction.php` (统计方法)
- `app/views/reports/dashboard.php`

**统计方法：**
- `getSummary()` - 获取收入/支出汇总
- `getTrend()` - 获取趋势数据
- `getByCategory()` - 按分类统计

### 4. 设置管理 (SettingController)

**功能：**
- **分类管理** (`categories`)
  - 创建/编辑/删除分类
  - 支持收入/支出/两者三种类型
  - 支持二级分类（parent_id）
  - 中越双语名称
  - 激活/停用状态

- **支付方式管理** (`paymentMethods`)
  - 创建/编辑/删除支付方式
  - 中越双语名称
  - 激活/停用状态
  - 默认包含：现金、POS机刷卡、VNPAY、ZaloPay、Momo

- **供应商管理** (`vendors`)
  - 创建/编辑/删除供应商
  - 包含名称、电话、备注
  - 激活/停用状态

**权限要求：**
- 仅限老板、店长、财务角色操作

**实现位置：**
- `app/controllers/SettingController.php`
- `app/models/Category.php`
- `app/models/PaymentMethod.php`
- `app/models/Vendor.php`
- `app/views/settings/`

## 技术架构

### MVC 架构模式

```
请求流程：
用户请求 → public/index.php → Router::dispatch() 
→ Controller::action() → Model → View → 响应
```

### 核心组件

1. **路由系统** (`app/core/Router.php`)
   - 通过 `?r=controller/action` 参数路由
   - 自动加载对应的控制器和方法

2. **数据库层** (`app/core/DB.php`)
   - PDO 连接封装
   - 单例模式
   - 预处理语句防止 SQL 注入

3. **国际化系统** (`app/core/I18n.php`)
   - 支持中越双语
   - 通过 `?lang=zh` 或 `?lang=vi` 切换
   - Session 保存语言选择
   - 使用 `__('key')` 函数获取翻译

4. **CSRF 防护** (`app/core/Csrf.php`)
   - 表单提交时生成 token
   - 提交时验证 token

5. **响应处理** (`app/core/Response.php`)
   - JSON 响应封装

### 数据库设计

**核心表：**
1. `roles` - 角色表（4种角色）
2. `users` - 用户表
3. `categories` - 分类表（支持二级分类）
4. `payment_methods` - 支付方式表
5. `vendors` - 供应商表
6. `transactions` - 交易表（核心表）
7. `attachments` - 附件表（可选）

**关系：**
- users → roles (多对一)
- transactions → categories (多对一)
- transactions → payment_methods (多对一)
- transactions → vendors (多对一，可选)
- transactions → users (多对一，创建人)

## 安全特性

1. **SQL 注入防护**
   - 使用 PDO 预处理语句
   - 所有数据库操作都使用参数绑定

2. **XSS 防护**
   - 输出时使用 `htmlspecialchars()` 转义

3. **CSRF 防护**
   - 表单提交时验证 CSRF token

4. **密码安全**
   - 使用 `password_hash()` 加密
   - 使用 `password_verify()` 验证

5. **权限控制**
   - 基于角色的访问控制（RBAC）
   - 不同角色有不同的操作权限

## 功能清单

### ✅ 已实现功能

- [x] 用户登录/登出
- [x] 角色权限管理（4种角色）
- [x] 收入/支出录入
- [x] 交易列表与多条件筛选
- [x] 交易详情查看
- [x] 交易作废（权限控制）
- [x] Dashboard 统计（今日/本月/7天趋势）
- [x] 分类管理（支持二级分类）
- [x] 支付方式管理
- [x] 供应商管理
- [x] 中越双语支持
- [x] 响应式设计（移动端支持）

### 📊 数据统计功能

- 今日收入/支出统计
- 本月收入/支出统计
- 7天趋势分析
- 按分类统计
- 最近交易流水

### 🔍 筛选功能

- 按类型筛选（收入/支出）
- 按日期范围筛选
- 按分类筛选
- 按支付方式筛选
- 按创建人筛选
- 关键词搜索（备注、供应商）

## 代码质量分析

### 优点

1. **架构清晰**：MVC 模式，职责分离明确
2. **安全性好**：SQL 注入、XSS、CSRF 防护完善
3. **代码规范**：使用 PDO、预处理语句
4. **国际化支持**：中越双语，易于扩展
5. **权限控制**：基于角色的访问控制

### 可改进点

1. **错误处理**：可以增加更详细的错误日志
2. **代码复用**：部分重复代码可以提取为公共方法
3. **验证逻辑**：表单验证可以更完善
4. **API 设计**：可以增加 RESTful API 支持
5. **缓存机制**：可以增加缓存提升性能

## 默认数据

- **默认用户**：admin / admin123
- **默认角色**：老板(owner)、店长(manager)、财务(accountant)、员工(staff)
- **默认分类**：收入4种、支出6种
- **默认支付方式**：5种（现金、POS机刷卡、VNPAY、ZaloPay、Momo）

## 技术栈

- **后端**：PHP 7.4+ (原生 PHP，无框架)
- **数据库**：MySQL 5.7+ / MariaDB
- **前端**：HTML5, CSS3, JavaScript (原生)
- **架构**：MVC 模式
- **安全**：PDO, CSRF Token, Password Hash

## 总结

这是一个功能完整、架构清晰的财务管理系统。代码质量良好，安全性措施完善，适合小型商户使用。系统支持中越双语，具有良好的国际化基础。
