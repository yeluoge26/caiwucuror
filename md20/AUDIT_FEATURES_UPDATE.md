# 审核功能更新说明

## 📋 更新内容

本次更新实现了完整的交易审核流程，包括金额验证、分页功能和审核权限控制。

---

## ✅ 1. 金额验证功能

### 实现位置
- **后端验证**: `app/controllers/TransactionController.php`
- **前端验证**: `app/views/transactions/create.php`, `app/views/transactions/edit.php`

### 功能说明
- ✅ **后端验证**: 创建和编辑交易时，金额必须大于0
- ✅ **前端验证**: 表单提交前验证金额，防止无效数据提交
- ✅ **错误提示**: 金额无效时显示友好的错误消息

### 验证规则
- 金额必须 > 0
- 支持小数（step="0.01"）
- 最小值为 0.01

---

## ✅ 2. 交易列表分页功能

### 实现位置
- **模型**: `app/models/Transaction.php` - 新增 `count()` 方法
- **控制器**: `app/controllers/TransactionController.php`
- **视图**: `app/views/transactions/list.php`

### 功能说明
- ✅ **分页显示**: 每页显示20条记录
- ✅ **分页导航**: 显示上一页/下一页按钮
- ✅ **分页信息**: 显示当前页/总页数和总记录数
- ✅ **保持筛选**: 分页时保持所有筛选条件

### 使用方法
- 在交易列表页面底部可以看到分页控件
- 点击"上一页"或"下一页"切换页面
- 筛选条件在分页时自动保持

---

## ✅ 3. 交易审核流程

### 审核流程说明

1. **创建交易**
   - 所有新创建的交易默认状态为 `pending`（待审核）
   - 创建后不会立即显示在列表中（除非是owner查看待审核列表）

2. **审核交易**
   - 只有 **owner** 可以审核交易
   - 审核后将状态改为 `approved`（已审核）
   - 审核后的交易才会显示在列表中

3. **查看交易**
   - **普通用户**: 只能看到已审核的交易
   - **Owner**: 可以看到所有交易，包括待审核的

### 实现位置
- **控制器**: `app/controllers/TransactionController.php`
- **模型**: `app/models/Transaction.php`
- **视图**: `app/views/transactions/list.php`, `app/views/transactions/view.php`

### 权限控制
- **创建交易**: 所有登录用户
- **编辑交易**: owner、manager、accountant（仅限待审核状态）
- **审核交易**: **仅 owner**
- **作废交易**: owner、accountant

---

## ✅ 4. 交易编辑限制

### 实现位置
- **控制器**: `app/controllers/TransactionController.php` - `edit()` 方法
- **视图**: `app/views/transactions/edit.php`

### 限制规则
- ✅ **已审核的交易不允许编辑**
- ✅ **已作废的交易不允许编辑**
- ✅ **只有待审核（pending）状态的交易可以编辑**

### 用户体验
- 已审核的交易在列表和详情页不显示"编辑"按钮
- 尝试直接访问编辑页面会被重定向到详情页

---

## ✅ 5. 列表显示规则

### 默认显示
- **普通用户**: 只显示已审核（approved）的交易
- **Owner**: 默认显示已审核的交易，可以选择查看待审核的

### 筛选选项
- Owner可以在筛选条件中选择状态：
  - 全部（默认显示已审核）
  - 已审核（approved）
  - 待审核（pending）
- Owner可以点击"查看待审核"按钮快速查看所有待审核交易

### 实现位置
- **模型**: `app/models/Transaction.php` - `list()` 方法
- **控制器**: `app/controllers/TransactionController.php` - `list()` 方法
- **视图**: `app/views/transactions/list.php`

---

## ✅ 6. Dashboard统计更新

### 实现位置
- **控制器**: `app/controllers/ReportController.php`
- **模型**: `app/models/Transaction.php` - `getSummary()`, `getTrend()`

### 统计规则
- ✅ **今日统计**: 只统计已审核的交易
- ✅ **本月统计**: 只统计已审核的交易
- ✅ **7天趋势**: 只统计已审核的交易
- ✅ **最近流水**: 只显示已审核的交易

### 说明
- 待审核的交易不会影响统计数据
- 只有owner审核通过后，交易才会计入统计

---

## ✅ 7. 导出功能更新

### 实现位置
- **控制器**: `app/controllers/ExportController.php`

### 导出规则
- ✅ **默认导出**: 只导出已审核的交易
- ✅ **Owner权限**: Owner可以通过筛选条件导出待审核的交易
- ✅ **保持筛选**: 导出时保持列表页面的所有筛选条件

---

## 📊 数据流程

```
创建交易 → pending（待审核）
    ↓
Owner审核 → approved（已审核）→ 显示在列表中
    ↓
（可选）作废 → void（已作废）→ 不显示在列表中
```

---

## 🔐 权限矩阵

| 操作 | Owner | Manager | Accountant | Staff |
|------|-------|---------|------------|-------|
| 创建交易 | ✅ | ✅ | ✅ | ✅ |
| 查看已审核交易 | ✅ | ✅ | ✅ | ✅ |
| 查看待审核交易 | ✅ | ❌ | ❌ | ❌ |
| 编辑待审核交易 | ✅ | ✅ | ✅ | ❌ |
| 编辑已审核交易 | ❌ | ❌ | ❌ | ❌ |
| 审核交易 | ✅ | ❌ | ❌ | ❌ |
| 作废交易 | ✅ | ❌ | ✅ | ❌ |

---

## 🎯 使用指南

### 创建交易
1. 点击"记一笔"按钮
2. 填写交易信息（金额必须 > 0）
3. 提交后交易状态为"待审核"
4. 交易不会立即显示在列表中

### 审核交易（Owner）
1. 在交易列表点击"查看待审核"按钮
2. 或使用状态筛选选择"待审核"
3. 找到需要审核的交易，点击"审核通过"
4. 确认后交易状态变为"已审核"
5. 交易会显示在正常列表中

### 编辑交易
1. 只有待审核状态的交易可以编辑
2. 在列表或详情页点击"编辑"按钮
3. 修改信息后保存
4. 已审核的交易不显示编辑按钮

### 查看分页
1. 在交易列表底部可以看到分页控件
2. 显示格式：第 X / Y 页（共 Z 条）
3. 点击"上一页"或"下一页"切换

---

## 📝 语言包更新

### 新增翻译（中越双语）
- `tx.amount_invalid` - 金额必须大于0
- `tx.amount_hint` - 金额提示
- `tx.cannot_edit_approved` - 已审核的交易不允许修改
- `list.show_pending` - 查看待审核
- `list.page` - 第/Trang
- `list.prev` - 上一页/Trước
- `list.next` - 下一页/Sau
- `list.total` - 共/Tổng

---

## 🔧 技术细节

### 分页实现
- 使用 `LIMIT` 和 `OFFSET` 实现分页
- 每页20条记录
- 使用 `count()` 方法获取总记录数

### 审核流程
- 创建时默认 `status = 'pending'`
- 列表查询默认 `status = 'approved'`
- Owner可以通过筛选查看 `pending` 状态

### 金额验证
- 前端：HTML5 `min="0.01"` + JavaScript验证
- 后端：PHP `floatval()` + `> 0` 检查

---

## ⚠️ 注意事项

1. **审核权限**: 只有owner可以审核交易，请确保owner账户权限正确
2. **数据统计**: Dashboard和报表只统计已审核的交易
3. **编辑限制**: 已审核的交易无法编辑，如需修改请先作废再重新创建
4. **分页性能**: 大量数据时建议使用筛选条件减少查询量

---

## 🐛 已知问题

无

---

## 🔄 后续优化建议

1. 添加批量审核功能（Owner）
2. 添加审核历史记录
3. 添加审核备注功能
4. 优化分页性能（使用索引）
5. 添加导出时选择状态选项

---

**更新日期**: 2024年  
**版本**: v1.2.0

