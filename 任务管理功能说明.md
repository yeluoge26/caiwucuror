# 任务管理（Task）功能说明

## 功能概述

任务管理模块用于创建、分配、跟踪和审批任务。支持固定任务和临时任务，可以指派给特定用户或角色，支持罚款/奖励机制，并需要老板审批完成的任务。

---

## 一、核心功能

### 1. 任务创建

**权限要求：** 老板(owner)、店长(manager)

**功能特点：**
- ✅ 任务标题（必填）
- ✅ 任务类型：固定(fixed) / 临时(temporary)
- ✅ 描述说明
- ✅ 截止时间（日期 + 时间）
- ✅ 关联门店/区域（coffee/office/whiskey，未来可扩展）
- ✅ 指派类型：角色(role) / 用户(user)
- ✅ 指派角色或指派具体用户
- ✅ 是否需要拍照（require_photo）
- ✅ 是否需要上传附件（require_attachment）
- ✅ 罚款金额（可选）
- ✅ 奖励金额（可选）
- ✅ 货币类型（VND/USD）

**创建流程：**
1. 访问 `/index.php?r=tasks/create`
2. 填写任务信息
3. 选择指派方式（角色或用户）
4. 设置是否需要拍照/附件
5. 设置罚款/奖励金额（可选）
6. 提交创建

---

### 2. 任务列表

**权限要求：** 所有登录用户

**功能特点：**
- ✅ 分页显示（每页20条）
- ✅ 按状态筛选（待处理/进行中/已完成/已审批/已拒绝）
- ✅ 按类型筛选（固定/临时）
- ✅ 关键词搜索（标题、描述）
- ✅ 显示任务基本信息
- ✅ 快速操作按钮（查看、开始）

**权限控制：**
- 老板：可以看到所有任务
- 其他用户：只能看到分配给自己的任务

---

### 3. 任务详情

**权限要求：** 所有登录用户（只能查看分配给自己的任务，老板除外）

**功能特点：**
- ✅ 显示任务完整信息
- ✅ 显示任务状态
- ✅ 显示指派信息
- ✅ 显示完成信息（如有）
- ✅ 显示审批信息（如有）
- ✅ 显示附件（如有）
- ✅ 显示罚款/奖励金额
- ✅ 操作按钮：
  - 开始任务（如果状态为待处理）
  - 完成任务（如果状态为待处理或进行中）
  - 审批任务（老板，如果状态为已完成）

---

### 4. 完成任务

**权限要求：** 被指派的用户

**功能特点：**
- ✅ 填写完成说明
- ✅ 上传附件（如果任务要求）
- ✅ 支持图片、PDF、Word文档
- ✅ 文件大小限制：10MB
- ✅ 提交后状态变为"已完成"，等待老板审批

**完成流程：**
1. 被指派的用户访问任务详情
2. 点击"完成任务"按钮
3. 填写完成说明
4. 上传附件（如需要）
5. 提交完成

---

### 5. 审批任务

**权限要求：** 老板(owner)

**功能特点：**
- ✅ 查看任务完成信息
- ✅ 查看完成附件
- ✅ 填写审批说明
- ✅ 审批通过或拒绝
- ✅ 审批后状态变为"已审批"或"已拒绝"

**审批流程：**
1. 老板访问已完成的任务详情
2. 点击"审批任务"按钮
3. 查看完成信息和附件
4. 填写审批说明
5. 选择"审批通过"或"拒绝"
6. 提交审批

---

## 二、任务状态流转

```
待处理(pending) 
  ↓ [开始任务]
进行中(in_progress)
  ↓ [完成任务]
已完成(completed)
  ↓ [老板审批]
已审批(approved) 或 已拒绝(rejected)
```

---

## 三、数据库结构

### tasks 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| title | VARCHAR(255) | 任务标题 |
| type | ENUM | 任务类型：fixed/temporary |
| description | TEXT | 描述说明 |
| due_date | DATETIME | 截止时间 |
| store | VARCHAR(64) | 关联门店 |
| assign_type | ENUM | 指派类型：role/user |
| assign_role_id | INT | 指派角色ID |
| assign_user_id | INT | 指派用户ID |
| require_photo | TINYINT(1) | 是否需要拍照 |
| require_attachment | TINYINT(1) | 是否需要附件 |
| penalty_amount | DECIMAL(12,2) | 罚款金额 |
| reward_amount | DECIMAL(12,2) | 奖励金额 |
| currency | VARCHAR(8) | 货币 |
| status | ENUM | 状态：pending/in_progress/completed/approved/rejected |
| completed_at | DATETIME | 完成时间 |
| completed_by | INT | 完成人ID |
| completion_note | TEXT | 完成说明 |
| approved_at | DATETIME | 审批时间 |
| approved_by | INT | 审批人ID |
| approval_note | TEXT | 审批说明 |
| created_by | INT | 创建人ID |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### task_attachments 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| task_id | INT | 任务ID |
| file_path | VARCHAR(255) | 文件路径 |
| file_type | VARCHAR(32) | 文件类型 |
| uploaded_by | INT | 上传人ID |
| created_at | TIMESTAMP | 创建时间 |

---

## 四、路由列表

### Web 路由

- `tasks/list` - 任务列表
- `tasks/create` - 创建任务
- `tasks/view` - 任务详情
- `tasks/complete` - 完成任务
- `tasks/approve` - 审批任务
- `tasks/start` - 开始任务

---

## 五、权限矩阵

| 功能 | Owner | Manager | Accountant | Staff |
|------|-------|---------|------------|-------|
| 创建任务 | ✅ | ✅ | ❌ | ❌ |
| 查看所有任务 | ✅ | ❌ | ❌ | ❌ |
| 查看自己的任务 | ✅ | ✅ | ✅ | ✅ |
| 开始任务 | ✅ | ✅ | ✅ | ✅ |
| 完成任务 | ✅ | ✅ | ✅ | ✅ |
| 审批任务 | ✅ | ❌ | ❌ | ❌ |

---

## 六、使用示例

### 创建任务示例

1. **固定任务（每日清洁）**
   - 标题：每日店面清洁
   - 类型：固定
   - 描述：每天闭店前完成店面清洁
   - 截止时间：每天 22:00
   - 指派：员工角色
   - 需要拍照：是
   - 奖励金额：50,000 VND

2. **临时任务（设备维修）**
   - 标题：咖啡机维修
   - 类型：临时
   - 描述：咖啡机出现故障，需要维修
   - 截止时间：2024-12-25 18:00
   - 指派：店长（具体用户）
   - 需要附件：是
   - 罚款金额：100,000 VND（如果未按时完成）

---

## 七、技术实现

### 文件结构

```
app/
  models/
    Task.php              # 任务模型
    TaskAttachment.php    # 任务附件模型
  controllers/
    TaskController.php    # 任务控制器
  views/
    tasks/
      list.php           # 任务列表
      create.php         # 创建任务
      view.php           # 任务详情
      complete.php       # 完成任务
      approve.php        # 审批任务
```

### 核心方法

**Task 模型：**
- `create()` - 创建任务
- `find()` - 查找任务
- `list()` - 任务列表（支持筛选和分页）
- `count()` - 统计任务数量
- `complete()` - 完成任务
- `approve()` - 审批通过
- `reject()` - 审批拒绝
- `start()` - 开始任务

**TaskAttachment 模型：**
- `create()` - 创建附件记录
- `listByTask()` - 获取任务附件列表
- `saveUploads()` - 保存上传的附件

---

## 八、注意事项

1. **权限控制**
   - 只有老板和店长可以创建任务
   - 只有老板可以审批任务
   - 用户只能查看和操作分配给自己的任务

2. **文件上传**
   - 支持图片（JPG、PNG、GIF、WebP）
   - 支持文档（PDF、DOC、DOCX）
   - 单个文件最大 10MB
   - 文件保存在 `public/uploads/tasks/` 目录

3. **任务状态**
   - 任务状态会自动更新
   - 已完成的任务需要老板审批
   - 审批通过后任务状态变为"已审批"

4. **罚款/奖励**
   - 罚款和奖励金额为可选
   - 货币类型默认为 VND
   - 未来可以扩展为自动生成交易记录

---

## 九、未来扩展

1. **任务模板**：支持创建任务模板，快速创建重复任务
2. **任务提醒**：截止时间前自动提醒
3. **任务统计**：统计任务完成率、超时率等
4. **自动生成交易**：审批通过后自动生成奖励/罚款交易记录
5. **任务评论**：支持在任务中添加评论
6. **任务关联**：支持任务之间的关联关系
7. **批量操作**：支持批量创建、分配任务

---

*最后更新：2024年12月*

