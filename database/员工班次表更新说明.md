# 员工与班次管理 - 数据库更新说明

## 更新内容

本次更新为数据库添加以下两个新表：
1. **employees** - 员工表
2. **shifts** - 班次表

## 执行步骤

### 方法一：使用推荐脚本（最简单）

**文件：** `update_employees_shifts.sql`

#### 使用命令行执行：
```bash
mysql -u 用户名 -p 数据库名 < database/update_employees_shifts.sql
```

#### 使用 MySQL Workbench 或 phpMyAdmin：
1. 打开 `database/update_employees_shifts.sql` 文件
2. 复制全部内容
3. 在 SQL 编辑器中执行

#### 使用 MySQL 命令行：
```sql
mysql -u root -p
USE coffee_finance;
SOURCE database/update_employees_shifts.sql;
```

### 方法二：使用迁移脚本

**文件：** `migrate_add_employees_shifts.sql`

此脚本与 `update_employees_shifts.sql` 内容相同，可以互换使用。

## 重要提示

### ⚠️ 执行前必须备份数据库

```bash
# 备份命令示例
mysqldump -u 用户名 -p 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 检查数据库名

- 默认数据库名：`coffee_finance`
- 如果您的数据库名不同，请修改 SQL 文件中的 `USE coffee_finance;` 语句

### 权限要求

- 需要 CREATE TABLE 权限
- 需要创建外键的权限
- 需要创建索引的权限

## 表结构说明

### employees 表（员工表）

**主要字段：**
- `name` - 姓名（必填）
- `role_id` - 角色ID（外键关联 roles 表）
- `phone` - 联系电话
- `email` - 邮箱
- `address` - 地址
- `status` - 状态（active/inactive/resigned）
- `hire_date` - 入职时间
- `resign_date` - 离职时间

**外键关系：**
- `role_id` → `roles.id`
- `created_by` → `users.id`

### shifts 表（班次表）

**主要字段：**
- `shift_date` - 日期（必填）
- `shift_type` - 班次类型（morning/afternoon/evening）
- `employee_id` - 员工ID（外键关联 employees 表）
- `manager_id` - 负责人ID（外键关联 employees 表，可选）
- `is_confirmed` - 到岗确认（0=未确认，1=已到岗）
- `confirmed_at` - 确认时间
- `confirmed_by` - 确认人ID（外键关联 users 表）

**外键关系：**
- `employee_id` → `employees.id`
- `manager_id` → `employees.id`
- `confirmed_by` → `users.id`
- `created_by` → `users.id`

**唯一约束：**
- `(shift_date, employee_id, shift_type)` - 防止同一员工同一天同一班次重复

## 验证安装

执行以下 SQL 命令验证表是否创建成功：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'employees';
SHOW TABLES LIKE 'shifts';

-- 查看表结构
DESC employees;
DESC shifts;

-- 查看表的详细信息
SHOW CREATE TABLE employees;
SHOW CREATE TABLE shifts;

-- 检查索引
SHOW INDEX FROM employees;
SHOW INDEX FROM shifts;
```

## 如果表已存在

如果表已经存在，脚本不会报错，也不会覆盖现有数据。您可以安全地多次执行这些脚本。

## 回滚（如果需要）

如果需要删除这些表（注意：会删除所有员工和班次数据）：

```sql
-- 删除班次表（先删除，因为有外键依赖）
DROP TABLE IF EXISTS shifts;

-- 删除员工表
DROP TABLE IF EXISTS employees;
```

## 常见问题

### Q: 执行时提示外键约束错误？
A: 确保以下表已存在：
- `roles` 表（角色表）
- `users` 表（用户表）

如果不存在，请先执行完整的 `schema.sql`。

### Q: 提示权限不足？
A: 确保数据库用户有以下权限：
- CREATE TABLE
- CREATE INDEX
- CREATE FOREIGN KEY

### Q: 如何修改数据库名？
A: 打开 SQL 文件，将 `USE coffee_finance;` 改为您的数据库名。

### Q: 执行后如何确认成功？
A: 执行验证命令，如果能看到表结构，说明创建成功。

### Q: 会影响现有数据吗？
A: 不会。此脚本只创建新表，不会修改或删除现有数据。

## 执行示例

### 示例 1：使用命令行
```bash
# Windows PowerShell
cd d:\code\caiwucuror\caiwucuror
mysql -u root -p coffee_finance < database/update_employees_shifts.sql

# Linux/Mac
cd /path/to/caiwucuror
mysql -u root -p coffee_finance < database/update_employees_shifts.sql
```

### 示例 2：使用 MySQL 客户端
```sql
-- 连接到数据库
mysql -u root -p

-- 选择数据库
USE coffee_finance;

-- 执行脚本
SOURCE /path/to/database/update_employees_shifts.sql;

-- 或者直接复制粘贴 SQL 内容执行
```

### 示例 3：使用 phpMyAdmin
1. 登录 phpMyAdmin
2. 选择数据库 `coffee_finance`
3. 点击 "SQL" 标签
4. 打开 `update_employees_shifts.sql` 文件
5. 复制内容到 SQL 编辑器
6. 点击 "执行"

## 联系支持

如果遇到问题，请检查：
1. MySQL 版本（建议 5.7+ 或 8.0+）
2. 数据库字符集（建议 utf8mb4）
3. 用户权限
4. 错误日志

---

*最后更新：2024年12月*

