# 员工与班次管理 - 数据库更新说明

## 更新内容

本次更新为数据库添加以下内容：
1. **employees** - 员工表（新增表）
2. **shifts** - 班次表（新增表）
3. **employees.employment_type** - 员工表的雇佣类型字段（全职/兼职）

## 更新步骤

### 第一步：创建员工和班次表

执行 `update_employees_shifts.sql` 创建新表。

### 第二步：添加雇佣类型字段（如果表已存在）

如果员工表已经存在但没有 `employment_type` 字段，执行 `add_employee_employment_type.sql` 添加字段。

## 执行方法

### 方法一：使用推荐脚本（最简单）

**文件：** `update_employees_shifts.sql`（创建表）
**文件：** `add_employee_employment_type.sql`（添加字段，如果表已存在）

#### 使用命令行执行：
```bash
# 1. 创建员工和班次表
mysql -u 用户名 -p 数据库名 < database/update_employees_shifts.sql

# 2. 如果员工表已存在，添加雇佣类型字段
mysql -u 用户名 -p 数据库名 < database/add_employee_employment_type.sql
```

#### 使用 MySQL Workbench 或 phpMyAdmin：
1. 打开 SQL 文件
2. 复制全部内容
3. 在 SQL 编辑器中执行

## 重要提示

### ⚠️ 执行前必须备份数据库

```bash
# 备份命令示例
mysqldump -u 用户名 -p 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 检查数据库名

- 默认数据库名：`coffee_finance`
- 如果您的数据库名不同，请修改 SQL 文件中的 `USE coffee_finance;` 语句

### 权限要求

- 需要 CREATE TABLE 权限（创建表）
- 需要 ALTER TABLE 权限（添加字段）
- 需要创建外键的权限
- 需要创建索引的权限

## 表结构说明

### employees 表（员工表）

**主要字段：**
- `name` - 姓名（必填）
- `role_id` - 角色ID（外键关联 roles 表）
- `phone` - 联系电话
- `email` - 邮箱
- `address` - 地址
- `status` - 状态（active/inactive/resigned）
- **`employment_type` - 雇佣类型（full_time/part_time）** ⭐ 新增
- `hire_date` - 入职时间
- `resign_date` - 离职时间

**外键关系：**
- `role_id` → `roles.id`
- `created_by` → `users.id`

### shifts 表（班次表）

**主要字段：**
- `shift_date` - 日期（必填）
- `shift_type` - 班次类型（morning/afternoon/evening）
- `employee_id` - 员工ID（外键关联 employees 表）
- `manager_id` - 负责人ID（外键关联 employees 表，可选）
- `is_confirmed` - 到岗确认（0=未确认，1=已到岗）
- `confirmed_at` - 确认时间
- `confirmed_by` - 确认人ID（外键关联 users 表）

**外键关系：**
- `employee_id` → `employees.id`
- `manager_id` → `employees.id`
- `confirmed_by` → `users.id`
- `created_by` → `users.id`

**唯一约束：**
- `(shift_date, employee_id, shift_type)` - 防止同一员工同一天同一班次重复

## 验证安装

执行以下 SQL 命令验证表是否创建成功：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'employees';
SHOW TABLES LIKE 'shifts';

-- 查看表结构
DESC employees;
DESC shifts;

-- 检查 employment_type 字段是否存在
SHOW COLUMNS FROM employees LIKE 'employment_type';

-- 查看表的详细信息
SHOW CREATE TABLE employees;
SHOW CREATE TABLE shifts;
```

## 如果表已存在

### 情况1：表已存在，但没有 employment_type 字段

执行 `add_employee_employment_type.sql` 添加字段。现有数据的 `employment_type` 将默认为 `full_time`。

### 情况2：表已存在，且已有 employment_type 字段

不需要执行任何操作。

## 回滚（如果需要）

如果需要删除这些表（注意：会删除所有员工和班次数据）：

```sql
-- 删除班次表（先删除，因为有外键依赖）
DROP TABLE IF EXISTS shifts;

-- 删除员工表
DROP TABLE IF EXISTS employees;
```

如果需要删除 employment_type 字段：

```sql
ALTER TABLE employees DROP COLUMN employment_type;
```

## 常见问题

### Q: 执行时提示外键约束错误？
A: 确保以下表已存在：
- `roles` 表（角色表）
- `users` 表（用户表）

如果不存在，请先执行完整的 `schema.sql`。

### Q: 提示权限不足？
A: 确保数据库用户有 CREATE TABLE、ALTER TABLE 和创建外键的权限。

### Q: 如何修改数据库名？
A: 打开 SQL 文件，将 `USE coffee_finance;` 改为您的数据库名。

### Q: 执行后如何确认成功？
A: 执行验证命令，如果能看到表结构和 employment_type 字段，说明创建成功。

### Q: 会影响现有数据吗？
A: 不会。此脚本只创建新表和添加新字段，不会修改或删除现有数据。现有员工的 employment_type 将默认为 full_time。

## 执行示例

### 示例 1：使用命令行（完整流程）
```bash
# Windows PowerShell
cd d:\code\caiwucuror\caiwucuror

# 1. 创建员工和班次表
mysql -u root -p coffee_finance < database/update_employees_shifts.sql

# 2. 如果表已存在，添加雇佣类型字段
mysql -u root -p coffee_finance < database/add_employee_employment_type.sql
```

### 示例 2：使用 MySQL 客户端
```sql
-- 连接到数据库
mysql -u root -p

-- 选择数据库
USE coffee_finance;

-- 1. 执行创建表脚本
SOURCE /path/to/database/update_employees_shifts.sql;

-- 2. 如果表已存在，执行添加字段脚本
SOURCE /path/to/database/add_employee_employment_type.sql;
```

### 示例 3：使用 phpMyAdmin
1. 登录 phpMyAdmin
2. 选择数据库 `coffee_finance`
3. 点击 "SQL" 标签
4. 打开 `update_employees_shifts.sql` 文件，复制内容执行
5. 如果表已存在，打开 `add_employee_employment_type.sql` 文件，复制内容执行

---

*最后更新：2024年12月*
