# 数据库更新说明 - 任务管理功能

## 概述

此更新为数据库添加任务管理功能所需的表结构，**不会影响现有数据**。

## 更新内容

新增两个表：
1. `tasks` - 任务主表
2. `task_attachments` - 任务附件表

## 执行步骤

### 方法一：使用推荐脚本（最简单）

**文件：** `migrate_add_tasks.sql`

```bash
# 方式1：使用命令行
mysql -u 用户名 -p 数据库名 < database/migrate_add_tasks.sql

# 方式2：使用 MySQL Workbench 或 phpMyAdmin
# 打开 migrate_add_tasks.sql 文件，复制内容，在 SQL 编辑器中执行
```

### 方法二：使用 CREATE IF NOT EXISTS 脚本

**文件：** `add_tasks_tables.sql`

此脚本使用 `CREATE TABLE IF NOT EXISTS`，如果表已存在则不会报错。

### 方法三：使用动态检查脚本（高级）

**文件：** `update_tasks_tables.sql`

此脚本会先检查表是否存在，然后决定是否创建。

## 重要提示

1. **备份数据库**
   ```sql
   mysqldump -u 用户名 -p 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **检查数据库名**
   - 默认数据库名：`coffee_finance`
   - 如果您的数据库名不同，请修改 SQL 文件中的 `USE coffee_finance;` 语句

3. **权限要求**
   - 需要 CREATE TABLE 权限
   - 需要创建外键的权限

## 验证安装

执行以下 SQL 命令验证表是否创建成功：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'tasks';
SHOW TABLES LIKE 'task_attachments';

-- 查看表结构
DESC tasks;
DESC task_attachments;

-- 查看表的详细信息
SHOW CREATE TABLE tasks;
SHOW CREATE TABLE task_attachments;
```

## 如果表已存在

如果表已经存在，脚本不会报错，也不会覆盖现有数据。您可以安全地多次执行这些脚本。

## 回滚（如果需要）

如果需要删除这些表（注意：会删除所有任务数据）：

```sql
-- 删除任务附件表（先删除，因为有外键依赖）
DROP TABLE IF EXISTS task_attachments;

-- 删除任务表
DROP TABLE IF EXISTS tasks;
```

## 常见问题

### Q: 执行时提示外键约束错误？
A: 确保 `roles` 和 `users` 表已存在。如果不存在，请先执行完整的 `schema.sql`。

### Q: 提示权限不足？
A: 确保数据库用户有 CREATE TABLE 和创建外键的权限。

### Q: 如何修改数据库名？
A: 打开 SQL 文件，将 `USE coffee_finance;` 改为您的数据库名。

### Q: 执行后如何确认成功？
A: 执行验证命令，如果能看到表结构，说明创建成功。

## 联系支持

如果遇到问题，请检查：
1. MySQL 版本（建议 5.7+ 或 8.0+）
2. 数据库字符集（建议 utf8mb4）
3. 用户权限
4. 错误日志

---

*最后更新：2024年12月*

